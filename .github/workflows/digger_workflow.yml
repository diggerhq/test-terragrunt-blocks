name: Digger Workflow

on:
  workflow_dispatch:
    inputs:
      id:
        description: 'run identifier'
        required: false
      job:
        required: true
      comment_id:
        required: true

jobs:
    run-digger:
      runs-on: zon-ubuntu-general-dind

      permissions:
        contents: write      # required to merge PRs
        id-token: write      # required for workload-identity-federation
        pull-requests: write # required to post PR comments
        statuses: write      # required to validate combined PR status

      steps:

        - name: Vault OIDC Auth
          uses: hashicorp/vault-action@v3.0.0
          id: vault
          with:
            url: ${{ secrets.VAULT_ADDR }}
            method: jwt
            path: github-actions
            role: terraform-ops
            exportToken: true
            secrets: zon/v1/github/atlantis gh_token

        - name: Write gitconfig
          run: git config --global url."https://oauth2:${{ steps.vault.outputs.gh_token }}@github.com".insteadOf ssh://git@github.com # replace ssh auth with https token auth for private terraform-module repo

        - name: digger run
          uses: diggerhq/digger@v0.4.10
          with:
            digger-token: ${{ secrets.DIGGER_TOKEN_DEVEL }}
            # digger-organisation: "Zeit Online"
            digger-organisation: "digger" # needed for self-hosted digger
            digger-hostname: "https://digger.devel.zon.zeit.de"
            # digger-hostname: 'https://cloud.digger.dev'
            setup-google-cloud: true #needed, or auth step is skipped
            google-workload-identity-provider: ${{ vars.GHA_WIF_PROVIDER }}
            google-service-account: gha-terraform@zeitonline-engineering.iam.gserviceaccount.com
            # google-workload-identity-provider-audience: google-wif
            disable-locking: false
          env:
            GITHUB_CONTEXT: ${{ toJson(github) }}
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            DEBUG: 'true'
            VAULT_ADDR: https://vault.ops.zeit.de
            LOCK_PROVIDER: gcp
            GOOGLE_STORAGE_BUCKET: zon-digger-poc-lock
